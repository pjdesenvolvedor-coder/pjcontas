{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Stores non-sensitive user profile information, linked to an external authentication system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserProfile entity."
        },
        "email": {
          "type": "string",
          "description": "User's primary email address for communication. Not used for authentication.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "The user's first name."
        },
        "lastName": {
          "type": "string",
          "description": "The user's last name."
        },
        "registrationDate": {
          "type": "string",
          "description": "The date and time when the user registered.",
          "format": "date-time"
        },
        "profileImageUrl": {
          "type": "string",
          "description": "URL to the user's profile picture.",
          "format": "uri"
        },
        "preferredLanguage": {
          "type": "string",
          "description": "The user's preferred language for the application interface."
        },
        "country": {
          "type": "string",
          "description": "The user's country of residence."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName",
        "registrationDate"
      ]
    },
    "StreamingService": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StreamingService",
      "type": "object",
      "description": "Represents a streaming service provider (e.g., Netflix, Disney+, HBO Max).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the StreamingService entity."
        },
        "name": {
          "type": "string",
          "description": "The official name of the streaming service."
        },
        "description": {
          "type": "string",
          "description": "A brief description of the streaming service."
        },
        "logoUrl": {
          "type": "string",
          "description": "URL to the official logo of the streaming service.",
          "format": "uri"
        },
        "websiteUrl": {
          "type": "string",
          "description": "URL to the official website of the streaming service.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "logoUrl",
        "websiteUrl"
      ]
    },
    "SubscriptionPlan": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SubscriptionPlan",
      "type": "object",
      "description": "Defines a specific subscription plan offered by a streaming service.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SubscriptionPlan entity."
        },
        "serviceId": {
          "type": "string",
          "description": "Reference to the StreamingService this plan belongs to. (Relationship: StreamingService 1:N SubscriptionPlan)"
        },
        "name": {
          "type": "string",
          "description": "The name of the subscription plan (e.g., 'Basic', 'Standard', 'Premium')."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the plan's features and benefits."
        },
        "price": {
          "type": "number",
          "description": "The monthly or annual price of the subscription plan."
        },
        "currency": {
          "type": "string",
          "description": "The currency in which the subscription price is denominated (e.g., 'USD', 'BRL')."
        },
        "userLimit": {
          "type": "number",
          "description": "The maximum number of simultaneous users allowed for this plan."
        },
        "features": {
          "type": "array",
          "description": "A list of key features included in this plan (e.g., 'HD Quality', '4K Ultra HD', 'Downloadable Content').",
          "items": {
            "type": "string"
          }
        },
        "isActive": {
          "type": "boolean",
          "description": "Indicates if the subscription plan is currently active and available for purchase."
        }
      },
      "required": [
        "id",
        "serviceId",
        "name",
        "description",
        "price",
        "currency",
        "userLimit",
        "isActive"
      ]
    },
    "UserSubscription": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserSubscription",
      "type": "object",
      "description": "Records a user's active or historical subscription to a specific plan.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserSubscription entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who owns this subscription. (Relationship: UserProfile 1:N UserSubscription)"
        },
        "planId": {
          "type": "string",
          "description": "Reference to the SubscriptionPlan this user is subscribed to. (Relationship: SubscriptionPlan 1:N UserSubscription)"
        },
        "startDate": {
          "type": "string",
          "description": "The date and time when the subscription became active.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "The date and time when the subscription is scheduled to end or has ended.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The current status of the subscription (e.g., 'active', 'cancelled', 'paused', 'expired')."
        },
        "autoRenew": {
          "type": "boolean",
          "description": "Indicates whether the subscription is set to automatically renew."
        }
      },
      "required": [
        "id",
        "userId",
        "planId",
        "startDate",
        "status",
        "autoRenew"
      ]
    },
    "PaymentTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PaymentTransaction",
      "type": "object",
      "description": "Logs individual payment transactions made by users for their subscriptions.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PaymentTransaction entity."
        },
        "userSubscriptionId": {
          "type": "string",
          "description": "Reference to the UserSubscription this payment is for. (Relationship: UserSubscription 1:N PaymentTransaction)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile who made the payment. (Relationship: UserProfile 1:N PaymentTransaction)"
        },
        "amount": {
          "type": "number",
          "description": "The amount of the payment."
        },
        "currency": {
          "type": "string",
          "description": "The currency of the payment (e.g., 'USD', 'BRL')."
        },
        "transactionDate": {
          "type": "string",
          "description": "The date and time when the payment transaction occurred.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "The status of the transaction (e.g., 'completed', 'failed', 'pending')."
        },
        "gatewayTransactionId": {
          "type": "string",
          "description": "The unique identifier provided by the payment gateway for this transaction."
        }
      },
      "required": [
        "id",
        "userSubscriptionId",
        "userId",
        "amount",
        "currency",
        "transactionDate",
        "status"
      ]
    },
    "UserPreference": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserPreference",
      "type": "object",
      "description": "Stores user preferences for content genres or service providers to aid in subscription recommendations.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the UserPreference entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the UserProfile these preferences belong to. (Relationship: UserProfile 1:N UserPreference)"
        },
        "genrePreferences": {
          "type": "array",
          "description": "A list of genres the user prefers (e.g., 'Action', 'Comedy', 'Drama').",
          "items": {
            "type": "string"
          }
        },
        "streamingServicePreferences": {
          "type": "array",
          "description": "References to StreamingServices the user explicitly prefers. (Relationship: UserProfile N:N StreamingService via preferences)",
          "items": {
            "type": "string"
          }
        },
        "lastUpdated": {
          "type": "string",
          "description": "The date and time when the preferences were last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "lastUpdated"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores non-sensitive user profile information. Document ID MUST be the `request.auth.uid`. Includes denormalized 'id' matching `userId` for authorization independence, ensuring only the authenticated user can read/write their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, corresponding to Firebase Authentication UID."
            }
          ]
        }
      },
      {
        "path": "/streamingServices/{serviceId}",
        "definition": {
          "entityName": "StreamingService",
          "schema": {
            "$ref": "#/backend/entities/StreamingService"
          },
          "description": "Stores global information about streaming service providers. Publicly readable by all authenticated and unauthenticated users. Write access restricted to administrators, ensuring data integrity.",
          "params": [
            {
              "name": "serviceId",
              "description": "The unique identifier for the streaming service."
            }
          ]
        }
      },
      {
        "path": "/streamingServices/{serviceId}/subscriptionPlans/{planId}",
        "definition": {
          "entityName": "SubscriptionPlan",
          "schema": {
            "$ref": "#/backend/entities/SubscriptionPlan"
          },
          "description": "Defines specific subscription plans offered by a streaming service. Publicly readable. Write access restricted to administrators. The 'serviceId' is part of the path, and the document contains 'serviceId' for explicit linkage.",
          "params": [
            {
              "name": "serviceId",
              "description": "The unique identifier for the parent streaming service."
            },
            {
              "name": "planId",
              "description": "The unique identifier for the subscription plan."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/subscriptions/{userSubscriptionId}",
        "definition": {
          "entityName": "UserSubscription",
          "schema": {
            "$ref": "#/backend/entities/UserSubscription"
          },
          "description": "Records a user's active or historical subscription. Only readable/writable by the owning user. Includes denormalized `userId` matching the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user (Firebase Authentication UID)."
            },
            {
              "name": "userSubscriptionId",
              "description": "The unique identifier for the user's subscription record."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/paymentTransactions/{transactionId}",
        "definition": {
          "entityName": "PaymentTransaction",
          "schema": {
            "$ref": "#/backend/entities/PaymentTransaction"
          },
          "description": "Logs individual payment transactions made by users for their subscriptions. Only readable by the owning user (write access typically via secure backend functions). Includes denormalized `userId` matching the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user (Firebase Authentication UID)."
            },
            {
              "name": "transactionId",
              "description": "The unique identifier for the payment transaction."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/preferences",
        "definition": {
          "entityName": "UserPreference",
          "schema": {
            "$ref": "#/backend/entities/UserPreference"
          },
          "description": "Stores user preferences for content genres or service providers. This is a subcollection with a single document (document ID can be a static value like 'default'). Only readable/writable by the owning user. Includes denormalized `userId` matching the path for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user (Firebase Authentication UID)."
            }
          ]
        }
      }
    ],
    "reasoning": "The recommended Firestore structure for StreamShare prioritizes security, scalability, and debuggability by strictly adhering to the core design principles. The primary strategy for Authorization Independence is implemented by ensuring that all documents requiring user-specific access control (UserProfile, UserSubscription, PaymentTransaction, UserPreference) are stored under a top-level `/users/{userId}` collection. The `userId` in the path segment directly corresponds to the `request.auth.uid` and is also explicitly stored as `userId` within the respective document. This denormalization eliminates the need for `get()` calls in security rules to check parent document ownership, simplifying rules and enabling atomic operations.\n\nFor globally accessible data (StreamingService, SubscriptionPlan), dedicated root-level collections are used. These collections inherently have a homogeneous security posture (public read, admin write), making their rules straightforward. Subscription plans are nested under streaming services (`/streamingServices/{serviceId}/subscriptionPlans/{planId}`) for logical organization, but their read access is independent of any specific user's attributes.\n\nQAPs (Queries are not Filters) are addressed by this structure through strict segregation. User-specific data is always scoped under `/users/{userId}/...`, allowing clients to query their own data securely and efficiently using `request.auth.uid` as the `userId` wildcard. For example, a user can list all their subscriptions by querying `/users/{request.auth.uid}/subscriptions`. Global data, like streaming services and subscription plans, can be listed by anyone without security filters, as they are universally readable. This clear separation ensures that security rules do not become complex filters that can be bypassed, but rather act as explicit access gates based on structural ownership or global permissions."
  }
}